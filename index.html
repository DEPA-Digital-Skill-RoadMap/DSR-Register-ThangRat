<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>สมัครโครงการ Digital Skill Roadmap</title>
  <script src="https://czp.dga.or.th/cportal/sdk/iu/v3/sdk.js"></script>
  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://czp.dga.or.th/cportal/sdk/css/v1/trunks.min.css" />
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Round" rel="stylesheet">
  <link rel="stylesheet" href="./index.css">

  <style>
    body { font-family: "Segoe UI", sans-serif; }
    select { width: 100%; margin: 8px 0; padding: 8px; }
    .hidden { display: none; }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="topnav">
    <img src="./image/Logo_Digital_Skill_Roadmap_288x288px_BG-removebg-preview.png" alt="dsr" width="128" height="128">
  </div>

  <!-- Main Form -->
  <div class="box">
    <section class="section">
      <p style="font-size: large; font-weight: bold;">
        ยืนยันตัวตนเพื่อสมัครเข้าร่วมโครงการ Digital Skill Roadmap
      </p>
      <br><br>

      <!-- Personal Info -->
      <fieldset disabled>
        <div class="field">
          <label class="label">IDCARD</label>
          <input id="idcard" class="input" type="text" placeholder="1103703753822">
        </div>

        <div class="field">
          <label class="label">ชื่อ (First name)</label>
          <input id="name" class="input" type="text" placeholder="สมชาย">
        </div>

        <div class="field">
          <label class="label">นามสกุล (Last name)</label>
          <input id="surname" class="input" type="text" placeholder="สมชาย">
        </div>

        <div class="field">
          <label class="label">อีเมล</label>
          <input id="email" class="input" type="email" placeholder="e.g. alexsmith@gmail.com">
        </div>

        <div class="field">
          <label class="label">เบอร์โทร</label>
          <input id="Numphone" class="input" type="text" placeholder="08x-xxx-xxxx">
        </div>

        <div class="field">
          <label class="label">วันเดือนปีเกิด</label>
          <input id="Birth" class="input" type="text" placeholder="20xx-xx-xx">
        </div>

        
      </fieldset>
      <div>
          <label> เพศ </label>
            <select name="gender" id="gender">
              <option value="">-- เลือกเพศ --</option>
              <option>ชาย</option>
              <option>หญิง</option>
              <option>ไม่ระบุ</option>
            </select>
      </div>

    <div>
      <label>จังหวัด</label>
      <select name="province" id="province">
        <option value="">-- เลือกจังหวัด --</option>
        <option value="กรุงเทพมหานคร">กรุงเทพมหานคร</option>
        <option value="กระบี่">กระบี่</option>
        <option value="กาญจนบุรี">กาญจนบุรี</option>
        <option value="กาฬสินธุ์">กาฬสินธุ์</option>
        <option value="กำแพงเพชร">กำแพงเพชร</option>
        <option value="ขอนแก่น">ขอนแก่น</option>
        <option value="จันทบุรี">จันทบุรี</option>
        <option value="ฉะเชิงเทรา">ฉะเชิงเทรา</option>
        <option value="ชลบุรี">ชลบุรี</option>
        <option value="ชัยนาท">ชัยนาท</option>
        <option value="ชัยภูมิ">ชัยภูมิ</option>
        <option value="ชุมพร">ชุมพร</option>
        <option value="เชียงราย">เชียงราย</option>
        <option value="เชียงใหม่">เชียงใหม่</option>
        <option value="ตรัง">ตรัง</option>
        <option value="ตราด">ตราด</option>
        <option value="ตาก">ตาก</option>
        <option value="นครนายก">นครนายก</option>
        <option value="นครปฐม">นครปฐม</option>
        <option value="นครพนม">นครพนม</option>
        <option value="นครราชสีมา">นครราชสีมา</option>
        <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
        <option value="นครสวรรค์">นครสวรรค์</option>
        <option value="นนทบุรี">นนทบุรี</option>
        <option value="นราธิวาส">นราธิวาส</option>
        <option value="น่าน">น่าน</option>
        <option value="บึงกาฬ">บึงกาฬ</option>
        <option value="บุรีรัมย์">บุรีรัมย์</option>
        <option value="ปทุมธานี">ปทุมธานี</option>
        <option value="ประจวบคีรีขันธ์">ประจวบคีรีขันธ์</option>
        <option value="ปราจีนบุรี">ปราจีนบุรี</option>
        <option value="ปัตตานี">ปัตตานี</option>
        <option value="พระนครศรีอยุธยา">พระนครศรีอยุธยา</option>
        <option value="พะเยา">พะเยา</option>
        <option value="พังงา">พังงา</option>
        <option value="พัทลุง">พัทลุง</option>
        <option value="พิจิตร">พิจิตร</option>
        <option value="พิษณุโลก">พิษณุโลก</option>
        <option value="เพชรบุรี">เพชรบุรี</option>
        <option value="เพชรบูรณ์">เพชรบูรณ์</option>
        <option value="แพร่">แพร่</option>
        <option value="ภูเก็ต">ภูเก็ต</option>
        <option value="มหาสารคาม">มหาสารคาม</option>
        <option value="มุกดาหาร">มุกดาหาร</option>
        <option value="แม่ฮ่องสอน">แม่ฮ่องสอน</option>
        <option value="ยโสธร">ยโสธร</option>
        <option value="ยะลา">ยะลา</option>
        <option value="ร้อยเอ็ด">ร้อยเอ็ด</option>
        <option value="ระนอง">ระนอง</option>
        <option value="ระยอง">ระยอง</option>
        <option value="ราชบุรี">ราชบุรี</option>
        <option value="ลพบุรี">ลพบุรี</option>
        <option value="ลำปาง">ลำปาง</option>
        <option value="ลำพูน">ลำพูน</option>
        <option value="เลย">เลย</option>
        <option value="ศรีสะเกษ">ศรีสะเกษ</option>
        <option value="สกลนคร">สกลนคร</option>
        <option value="สงขลา">สงขลา</option>
        <option value="สตูล">สตูล</option>
        <option value="สมุทรปราการ">สมุทรปราการ</option>
        <option value="สมุทรสงคราม">สมุทรสงคราม</option>
        <option value="สมุทรสาคร">สมุทรสาคร</option>
        <option value="สระแก้ว">สระแก้ว</option>
        <option value="สระบุรี">สระบุรี</option>
        <option value="สิงห์บุรี">สิงห์บุรี</option>
        <option value="สุโขทัย">สุโขทัย</option>
        <option value="สุพรรณบุรี">สุพรรณบุรี</option>
        <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
        <option value="สุรินทร์">สุรินทร์</option>
        <option value="หนองคาย">หนองคาย</option>
        <option value="หนองบัวลำภู">หนองบัวลำภู</option>
        <option value="อ่างทอง">อ่างทอง</option>
        <option value="อำนาจเจริญ">อำนาจเจริญ</option>
        <option value="อุดรธานี">อุดรธานี</option>
        <option value="อุตรดิตถ์">อุตรดิตถ์</option>
        <option value="อุทัยธานี">อุทัยธานี</option>
        <option value="อุบลราชธานี">อุบลราชธานี</option>
      </select>
    </div>



      <!-- Course Selections -->
      <div>
        <label>กลุ่ม</label>
        <select id="group"></select>
      </div>

      <div>
        <label>กลุ่มย่อย</label>
        <select id="semigroup"></select>
      </div>

      <div>
        <label>ระดับหลักสูตร</label>
        <select id="level"></select>
      </div>

      <div>
        <label>กลุ่มหลักสูตร</label>
        <select id="coursegroup"></select>
      </div>

      <div>
        <label>หลักสูตร</label>
        <select id="course"></select>
      </div>

      <!-- Upload Instructions -->
      <div class="box">
        <div>วิธีการนำลิงก์สำเนาบัตรประชาชนและเอกสารเพิ่มเติมจาก Google Drive</div>
        <img src="./image/97e34777-4abd-4bb6-8be6-a42dc9a0d42a.png" alt="How to get link">
        <p>
          *ดูวิธีการอัปโหลดไฟล์แบบละเอียดได้ที่ลิงก์ด้านใต้<br>
          <a href="https://short.depa.or.th/a2Hqv" target="_blank">Click Here</a>
        </p>
      </div>

      <!-- Upload Fields -->
      <div class="field">
        <label class="label">ลิงก์สำเนาบัตรประชาชน (Google Drive)</label>
        <input id="IDCardlink" class="input" type="text" placeholder="drive link">
      </div>

      <div class="box">
        <p class="otherdoc">โปรดเลือกหลักสูตร...</p>
      </div>

      <div class="field">
        <label class="label">ลิงก์เอกสารเพิ่มเติม (Google Drive)</label>
        <input id="Otherdoclink" class="input" type="text" placeholder="drive link">
      </div>

      <!-- Submit -->
      <div style="margin-top: 20px;">
        <button id="submitBtn" class="button is-primary">บันทึกข้อมูล</button>
      </div>
    </section>
  </div>

  <!-- Loading Page -->
  <div id="loadingPage" class="hidden">
    <div class="screen-center">
      <div class="screen-loader">
        <div></div><div></div><div></div><div></div>
      </div>
      <br>กำลังส่งข้อมูล...
    </div>
  </div>

  <!-- Success Page -->
  <div id="successPage" class="hidden">
    <!-- <div class="screen-center">
      
      โครงการได้รับใบสมัครของท่านแล้ว<br>
      โปรดตรวจสอบข้อความใหม่ในอีเมล<br>
      หากยังไม่ได้รับ โปรดตรวจสอบใน Junk Mail หรือสมัครใหม่ภายใน 30 นาที<br>
      ติดตามข้อมูลข่าวสารได้ที่
      <a href="https://www.facebook.com/depathai" target="_blank">Facebook DEPATHAI</a>
      <br><br>
      <button id="backBtn">กลับหน้าแรก</button>
    </div> -->
  <div style="min-height:100vh; display:flex; justify-content:center; align-items:center; padding-bottom:4rem;">
    <div style="text-align:center; gap:1rem; display:flex; flex-direction:column; align-items:center;">

      <!-- ไอคอนติ๊กถูก -->
      <span class="has-text-success" style="display:flex; align-items:center; justify-content:center;">
        <span class="material-icons-round" style="font-size:5rem;">check_circle</span>
      </span>

      <!-- ข้อความหลัก -->
      <h6>โครงการได้รับใบสมัครของท่านแล้ว</h6>
      <span>โปรดตรวจสอบข้อความใหม่ในอีเมล</span>
      <span>หากยังไม่ได้รับ โปรดตรวจสอบใน Junk Mail หรือสมัครใหม่ภายใน 30 นาที</span>

      <!-- ลิงก์และปุ่ม -->
      <span>ติดตามข้อมูลข่าวสารได้ที่</span>
      <a href="https://www.facebook.com/depathai" target="_blank">Facebook DEPATHAI</a>

      <button id="backBtn" class="button is-success is-light" style="margin-top:1rem;">กลับหน้าแรก</button>
    </div>
  </div>


  <!-- Script -->
  <script>
    let BaseURL = "http://localhost:3000/api";
    let CONFIG = "";
    let Authen_Token = "";
    REQUIRE_OUT_FROM_THANGRAT=""
    init();

    // 🔹 เริ่มต้นโปรแกรม
    async function init() {
      try {
        // โหลดไฟล์ CONFIG
        const res = await fetch(`./IPCONFIG.json?t=${Date.now()}`);
        const data = await res.json();
        BaseURL = data.IsMaintanence === false ? "/api" : "http://18.139.142.149:4200/api";
        console.log("Maintenance:", data.IsMaintanence);
        console.log("BaseURL:", BaseURL);
      
        CONFIG = data;
        console.log('Log',CONFIG);
        console.log('Log',data);
        loadGroups();

        // 🔹 เรียกฟังก์ชัน LoadThangRatData() โดยส่ง CONFIG ที่พร้อมแล้ว
        await Verify_AuthenicationToken(CONFIG);

      } catch (err) {
        console.error("Error:", err);
      }
    }
    // get Authorization Token
    async function Verify_AuthenicationToken(CONFIG) {
      const res = await fetch(
        `https://api.egov.go.th/ws/auth/validate?ConsumerSecret=${CONFIG.ConsumerSecret}&AgentID=${CONFIG.AgentID}`,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Consumer-Key": CONFIG.ConsumerKey,
          },
        }
      );

      const data = await res.json();
      Authen_Token = data.Result;
      console.log("Authen Token:", Authen_Token);

      CallIdentity(CONFIG,Authen_Token);
    }
    //call data 
    async function CallIdentity(CONFIG,Authen_Token){
       const res = await fetch(`https://api.egov.go.th/ws/dga/czp/uat/v1/core/shield/data/deproc`,
        {
          method: "POST",
          headers:{
            "Consumer-Key": CONFIG.ConsumerKey,
            "Content-Type": "application/json",
            "Token":        Authen_Token
          },
          body: JSON.stringify({
            appId: window.czpSdk.getAppId() ,
            mToken: window.czpSdk.getToken()
          })
        }
      )
      const data  = await res.json();
      REQUIRE_OUT_FROM_THANGRAT = data.result;
      console.log(data.result);
      document.getElementById('idcard').value = data.result.citizenId || '';
      document.getElementById('name').value = data.result.firstName || '';
      document.getElementById('surname').value = data.result.lastName || '';
      document.getElementById('email').value = data.result.email || '';
      document.getElementById('Numphone').value = data.result.mobile || '';
      document.getElementById('Birth').value = data.result.dateOfBirthString || '';
    }
    // fetch('https://mocki.io/v1/20ecb20d-6232-4f21-b244-2909e7ea6272')
    //   .then(res => res.json())
    //   .then(data => {
    //     document.getElementById('idcard').value = data.idcard || '';
    //     document.getElementById('name').value = data.name || '';
    //     document.getElementById('surname').value = data.surname || '';
    //     document.getElementById('email').value = data.email || '';
    //     document.getElementById('Numphone').value = data.Numphone || '';
    //     document.getElementById('Birth').value = data.Birth || '';
    //   })
    //   .catch(err => console.error('Error:', err));

    

    // Dropdown Elements
    const groupSelect = document.getElementById("group");
    const semigroupSelect = document.getElementById("semigroup");
    const levelSelect = document.getElementById("level");
    const courseGroupSelect = document.getElementById("coursegroup");
    const courseSelect = document.getElementById("course");
    const otherdoc = document.querySelector(".otherdoc");

    // Load initial group list
    async function loadGroups() {
      const res = await fetch(`${BaseURL}/groups`);
      const data = await res.json();
      groupSelect.innerHTML = `<option value="">-- เลือก Group --</option>`;
      data.forEach(g => groupSelect.innerHTML += `<option value="${g.group}">${g.group}</option>`);
    }

    // Dynamic dropdown handlers
    groupSelect.addEventListener("change", async () => {
      const group = groupSelect.value;
      const res = await fetch(`${BaseURL}/semigroups?group=${encodeURIComponent(group)}`);
      const data = await res.json();
      semigroupSelect.innerHTML = `<option value="">-- เลือก Semigroup --</option>`;
      data.forEach(s => semigroupSelect.innerHTML += `<option value="${s.semigroup}">${s.semigroup}</option>`);
      levelSelect.innerHTML = courseGroupSelect.innerHTML = courseSelect.innerHTML = "";
    });

    semigroupSelect.addEventListener("change", async () => {
      const res = await fetch(`${BaseURL}/levels?group=${groupSelect.value}&semigroup=${semigroupSelect.value}`);
      const data = await res.json();
      levelSelect.innerHTML = `<option value="">-- เลือก Level --</option>`;
      data.forEach(l => levelSelect.innerHTML += `<option value="${l.level}">${l.level}</option>`);
      courseGroupSelect.innerHTML = courseSelect.innerHTML = "";
    });

    levelSelect.addEventListener("change", async () => {
      const res = await fetch(`${BaseURL}/coursegroups?group=${groupSelect.value}&semigroup=${semigroupSelect.value}&level=${levelSelect.value}`);
      const data = await res.json();
      courseGroupSelect.innerHTML = `<option value="">-- เลือกกลุ่มวิชา --</option>`;
      data.forEach(cg => courseGroupSelect.innerHTML += `<option value="${cg.coursegroup}">${cg.coursegroup}</option>`);
      courseSelect.innerHTML = "";
    });

    courseGroupSelect.addEventListener("change", async () => {
      const res = await fetch(`${BaseURL}/courses?group=${groupSelect.value}&semigroup=${semigroupSelect.value}&level=${levelSelect.value}&coursegroup=${courseGroupSelect.value}`);
      const data = await res.json();
      courseSelect.innerHTML = `<option value="">-- เลือกหลักสูตร --</option>`;
      data.forEach(c => courseSelect.innerHTML += `<option value="${c.courses}">${c.courses}</option>`);
    });

    courseSelect.addEventListener("change", async () => {
      const res = await fetch(`${BaseURL}/otherdocs?group=${encodeURIComponent(groupSelect.value)}&semigroup=${encodeURIComponent(semigroupSelect.value)}&level=${encodeURIComponent(levelSelect.value)}&coursegroup=${encodeURIComponent(courseGroupSelect.value)}&courses=${encodeURIComponent(courseSelect.value)}`);
      const data = await res.json();
      otherdoc.textContent = (data.length > 0 && data[0].otherdoc) ? data[0].otherdoc : "ไม่มีข้อมูล otherdoc";
    });

    // Submit Handler
    document.getElementById("submitBtn").addEventListener("click", async () => {
      const mainContent = document.querySelector(".box");
      const loadingPage = document.getElementById("loadingPage");
      const successPage = document.getElementById("successPage");
// idcard: REQUIRE_OUT_FROM_THANGRAT.citizenId,
//         name: REQUIRE_OUT_FROM_THANGRAT.firstName,
//         surname: REQUIRE_OUT_FROM_THANGRAT.lastName,
//         email: REQUIRE_OUT_FROM_THANGRAT.email,
//         Numphone: REQUIRE_OUT_FROM_THANGRAT.mobile,
//         Birth: REQUIRE_OUT_FROM_THANGRAT.dateOfBirthString,
      const payload = {
        // idcard: idcard.value,
        // name: name.value,
        // surname: surname.value,
        // email: email.value,
        // Numphone: Numphone.value,
        // Birth: Birth.value,
        idcard: REQUIRE_OUT_FROM_THANGRAT.citizenId,
        name: REQUIRE_OUT_FROM_THANGRAT.firstName,
        surname: REQUIRE_OUT_FROM_THANGRAT.lastName,
        email: REQUIRE_OUT_FROM_THANGRAT.email,
        Numphone: REQUIRE_OUT_FROM_THANGRAT.mobile,
        Birth: REQUIRE_OUT_FROM_THANGRAT.dateOfBirthString,
        gender: gender.value,
        province: province.value,
        IDCardlink: IDCardlink.value,
        Otherdoclink: Otherdoclink.value,
        group: groupSelect.value,
        semigroup: semigroupSelect.value,
        level: levelSelect.value,
        coursegroup: courseGroupSelect.value,
        course: courseSelect.value
      };

      if (!payload.group || !payload.level || !payload.course) {
        alert("กรุณาเลือกข้อมูลให้ครบก่อนส่ง!");
        return;
      }

      mainContent.style.display = "none";
      loadingPage.classList.remove("hidden");

      try {
        const res = await fetch(`${BaseURL}/saveSelection`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const result = await res.json();

        loadingPage.classList.add("hidden");

        if (result.success) successPage.classList.remove("hidden");
        else {
          alert("❌ เกิดข้อผิดพลาด: " + result.message);
          mainContent.style.display = "block";
        }
      } catch (err) {
        console.error(err);
        alert("⚠️ ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้");
        loadingPage.classList.add("hidden");
        mainContent.style.display = "block";
      }
    });

    // Back to main
    document.getElementById("backBtn").addEventListener("click", () => {
      document.getElementById("successPage").classList.add("hidden");
      document.querySelector(".box").style.display = "block";
    });
  </script>
</body>
</html>

<!-- HOW TO 101 (วิธีหา mToken , appID ): เอามาจาก postman โดยที่ทำถึงแค่ "02 MockData" -->
<!-- HOW TO 102   (วิธีเข้าลิ้ง) (localhost): http://DOMAINNAME/index.html?appId=XXXXXX&mToken=XXXXXXXXX -->
<!-- HOW TO 102.5 (วิธีเข้าลิ้ง) (domain/deployweb): http://DOMAIN/?appId=XXXXXX&mToken=XXXXXXXXX -->